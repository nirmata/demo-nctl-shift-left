name: NCTL Scan Terraform Demo
run-name: ${{ github.actor }} has triggered Scan Action üöÄ
on:
  pull_request:
    branches:
      - "main"

jobs:
  NCTL-Scan-Terraform:
    runs-on: ubuntu-latest
    # These permissions are needed to interact with GitHub's OIDC Token endpoint
    permissions:
      id-token: write   # This is required for requesting the JWT
      contents: read    # This is required for actions/checkout
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          # Checks out the repository linked to the PR
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          # Checks out the branch from the PR
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: nctl-scan-terraform-${{ github.event.pull_request.head.ref }}
          aws-region: us-west-2

      - name: Download and Install NCTL
        run: |
          echo "Downloading and Installing NCTL"
          wget https://nirmata-downloads.s3.us-east-2.amazonaws.com/nctl/nctl_4.10.1/nctl_4.10.1_linux_386.zip  
          unzip -o *.zip
          chmod 755 ./nctl
          sudo mv nctl /usr/local/bin/nctl
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."

      - name: Check nctl version
        run: nctl version

      - name: Login to Nirmata
        run: |
          nctl login --url https://www.nirmata.io --userid anusha.hegde@nirmata.com --token ${{ secrets.NIRMATA_TOKEN }}
          ./scripts/install-tf.sh

      - name: NCTL Scan - Terraform
        run: |
          nctl scan terraform --policies controls/cis-eks/infrastructure --resources config-files/terraform/eks/payload.json --publish

      - run: echo "üçè This job's status is ${{ job.status }}."
